import pytest
from decimal import Decimal
from uuid import uuid4

from {{ root_package }}.domain import (
    AssignmentPolicy, PricingService, OrderMatchingService,
    WeightGrams, MoneyAmount, VehicleVo, CourierEntity, CourierId, CourierStatus,
    OrderEnt, OrderId
)

@pytest.fixture
def matching_service():
    return OrderMatchingService(
        assignment_policy=AssignmentPolicy(),
        pricing_service=PricingService()
    )

def create_order(weight_g: int, address) -> OrderEnt:
    """Helper to create an assembled order with specific weight"""
    from {{ root_package }}.domain import LineItemVo
    
    order = OrderEnt(id=OrderId(uuid4()), address=address)
    item = LineItemVo(
        name="Load", 
        price=MoneyAmount(10), 
        weight=WeightGrams(weight_g), 
        quantity=1
    )
    order.add_item(item)
    order.mark_assembled()
    return order

def create_courier(capacity_g: int) -> CourierEntity:
    """Helper to create an idle courier with specific capacity"""
    vehicle = VehicleVo(
        plate_number="X", 
        model="M", 
        capacity=WeightGrams(capacity_g)
    )
    return CourierEntity(
        id=CourierId(uuid4()), 
        name="Driver", 
        vehicle=vehicle, 
        status=CourierStatus.IDLE
    )

def test_matching_prioritizes_heavy_orders_and_big_vehicles(matching_service, address_vo):
    """
    Scenario:
    - Order A: 50kg (Heavy)
    - Order B: 5kg  (Light)
    
    - Courier 1: 100kg Capacity (Truck)
    - Courier 2: 10kg  Capacity (Bike)
    
    Expected:
    - Truck takes Heavy Order
    - Bike takes Light Order
    """
    # Arrange
    order_heavy = create_order(50000, address_vo)
    order_light = create_order(5000, address_vo)
    
    courier_truck = create_courier(100000)
    courier_bike = create_courier(10000)
    
    orders = [order_light, order_heavy] # Unsorted input
    couriers = [courier_bike, courier_truck] # Unsorted input
    
    # Act
    deliveries = matching_service.match_batch(orders, couriers, base_fee=MoneyAmount(5))
    
    # Assert
    assert len(deliveries) == 2
    
    # Find match for heavy order
    heavy_delivery = next(d for d in deliveries if d.order == order_heavy)
    assert heavy_delivery.courier == courier_truck, "Truck should take heavy order"
    
    # Find match for light order
    light_delivery = next(d for d in deliveries if d.order == order_light)
    assert light_delivery.courier == courier_bike, "Bike should take light order"

def test_skips_impossible_matches(matching_service, address_vo):
    # Arrange
    order_heavy = create_order(50000, address_vo) # 50kg
    courier_bike = create_courier(10000)          # 10kg max
    
    # Act
    deliveries = matching_service.match_batch([order_heavy], [courier_bike], MoneyAmount(5))
    
    # Assert
    assert len(deliveries) == 0
    assert courier_bike.status == CourierStatus.IDLE