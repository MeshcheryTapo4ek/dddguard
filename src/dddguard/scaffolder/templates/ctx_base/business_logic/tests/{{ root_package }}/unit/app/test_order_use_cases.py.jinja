import pytest
from unittest.mock import ANY
from uuid import UUID

from {{ root_package }}.app.use_cases import (
    CreateOrderUseCase, 
    AddOrderItemUseCase, 
    AssembleOrderUseCase
)
from {{ root_package }}.app.errors import EntityNotFoundError
from {{ root_package }}.domain import OrderStatus, OrderEnt

def test_create_order_saves_to_repo(mock_repo):
    # Arrange
    use_case = CreateOrderUseCase(repo=mock_repo)
    
    # Act
    order_id = use_case.execute(city="Minsk", street="Lenina", building="10")
    
    # Assert
    assert isinstance(order_id, UUID)
    # Verify repository was called exactly once
    mock_repo.save_order.assert_called_once()
    
    # Verify arguments passed to save_order
    saved_order = mock_repo.save_order.call_args[0][0]
    assert isinstance(saved_order, OrderEnt)
    assert saved_order.address.city == "Minsk"
    assert saved_order.status == OrderStatus.ASSEMBLING

def test_add_item_fetches_and_saves(mock_repo, sample_order):
    # Arrange
    mock_repo.get_order.return_value = sample_order
    use_case = AddOrderItemUseCase(repo=mock_repo)
    
    # Act
    use_case.execute(
        order_id=sample_order.id,
        item_name="Book",
        price=500,
        weight_g=200,
        qty=2
    )
    
    # Assert
    mock_repo.get_order.assert_called_with(sample_order.id)
    assert len(sample_order.items) == 1
    assert sample_order.items[0].name == "Book"
    mock_repo.save_order.assert_called_with(sample_order)

def test_add_item_raises_if_order_not_found(mock_repo):
    # Arrange
    mock_repo.get_order.return_value = None # Order missing
    use_case = AddOrderItemUseCase(repo=mock_repo)
    
    # Act & Assert
    with pytest.raises(EntityNotFoundError):
        use_case.execute(
            order_id=UUID('00000000-0000-0000-0000-000000000000'),
            item_name="Item", price=10, weight_g=10, qty=1
        )

def test_assemble_order_changes_status(mock_repo, sample_order):
    # Arrange
    # Pre-fill order so it's not empty (domain rule)
    from {{ root_package }}.domain import LineItemVo, mk_money, mk_weight
    sample_order.items.append(LineItemVo(
        name="X", price=mk_money(1), weight=mk_weight(1), quantity=1
    ))
    
    mock_repo.get_order.return_value = sample_order
    use_case = AssembleOrderUseCase(repo=mock_repo)
    
    # Act
    use_case.execute(sample_order.id)
    
    # Assert
    assert sample_order.status == OrderStatus.ASSEMBLED
    mock_repo.save_order.assert_called_with(sample_order)