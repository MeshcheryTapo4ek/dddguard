import pytest
from unittest.mock import Mock

from {{ root_package }}.app.use_cases import MatchOrdersUseCase
from {{ root_package }}.domain import (
    OrderMatchingService, AssignmentPolicy, PricingService,
    LineItemVo, mk_money, mk_weight, OrderStatus, CourierStatus
)

@pytest.fixture
def real_matching_service():
    """
    We use the REAL domain service here because it's pure logic 
    and we want to test that UseCase correctly integrates it.
    """
    return OrderMatchingService(
        assignment_policy=AssignmentPolicy(),
        pricing_service=PricingService()
    )

def test_match_orders_orchestration(mock_repo, real_matching_service, sample_order, sample_courier):
    # Arrange
    # 1. Setup Order (Must be ASSEMBLED and have weight)
    item = LineItemVo(name="Box", price=mk_money(100), weight=mk_weight(5000), quantity=1)
    sample_order.items.append(item)
    sample_order.status = OrderStatus.ASSEMBLED # Force status for matching
    
    # 2. Setup Repo
    mock_repo.get_assembled_orders.return_value = [sample_order]
    mock_repo.get_idle_couriers.return_value = [sample_courier]
    
    use_case = MatchOrdersUseCase(repo=mock_repo, matching_service=real_matching_service)
    
    # Act
    deliveries = use_case.execute()
    
    # Assert
    assert len(deliveries) == 1
    
    # Verify persistence was called
    mock_repo.save_delivery.assert_called_once()
    mock_repo.save_courier.assert_called_once() # Status changed to BUSY
    mock_repo.save_order.assert_called_once()   # Typically updated
    
    # Verify side effects
    assert sample_courier.status == CourierStatus.BUSY
    assert deliveries[0].courier == sample_courier

def test_match_orders_does_nothing_if_no_data(mock_repo, real_matching_service):
    # Arrange
    mock_repo.get_assembled_orders.return_value = []
    mock_repo.get_idle_couriers.return_value = []
    
    use_case = MatchOrdersUseCase(repo=mock_repo, matching_service=real_matching_service)
    
    # Act
    deliveries = use_case.execute()
    
    # Assert
    assert deliveries == []
    mock_repo.save_delivery.assert_not_called()