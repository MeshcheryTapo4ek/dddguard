from dataclasses import dataclass
from decimal import Decimal

from ..interfaces import ILogisticsRepository
from ..errors import EntityNotFoundError
from ...domain import OrderId, LineItemVo, mk_money, mk_weight

@dataclass(frozen=True, kw_only=True, slots=True)
class AddOrderItemUseCase:
    repo: ILogisticsRepository

    def execute(
        self, 
        order_id: OrderId, 
        item_name: str, 
        price: float, 
        weight_g: int, 
        qty: int
    ) -> None:
        """
        Adds an item to an existing order.
        Converts primitives to Value Objects.
        """
        order = self.repo.get_order(order_id)
        if not order:
            raise EntityNotFoundError(entity_id=str(order_id), entity_type="Order")

        item = LineItemVo(
            name=item_name,
            price=mk_money(price),
            weight=mk_weight(weight_g),
            quantity=qty
        )

        # Domain Logic: Entity validates state (must be ASSEMBLING)
        order.add_item(item)
        
        self.repo.save_order(order)